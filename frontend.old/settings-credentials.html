<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="images/favicon.ico" type="image/ico" />
    <title>Credentials Settings - Cockpit</title>
    <script type="module" src="/src/main-minimal.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api-manager.js"></script>
    <script src="js/auth.js"></script>
    <style>
      .badge-expired {
        background: #dc3545;
      }
      .badge-expiring {
        background: #ffc107;
        color: #212529;
      }
      .badge-active {
        background: #28a745;
      }
      .modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 2000;
      }
      .modal-dialog {
        margin: 8% auto;
      }
      /* Compact action buttons */
      #credentialsTable td {
        vertical-align: middle;
      }
      .cred-btn {
        padding: 2px 6px !important;
        font-size: 11px;
        line-height: 1;
      }
      .cred-btn i {
        pointer-events: none;
      }
      .actions-cell {
        white-space: nowrap;
      }
      .actions-cell .action-buttons {
        display: flex;
        gap: 4px;
      }
      .actions-cell .action-buttons .btn {
        flex: 0 0 auto;
      }
    </style>
  </head>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0">
              <a href="index.html" class="site_title"
                ><i class="fas fa-paw"></i> <span>Cockpit!</span></a
              >
            </div>
            <div class="clearfix"></div>
            <div class="profile clearfix">
              <div class="profile_info">
                <span>Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <br />
            <div
              id="sidebar-menu"
              class="main_menu_side hidden-print main_menu"
            >
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li>
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-rocket"></i> Onboarding
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="onboard-device.html"
                          ><i class="fas fa-plus-circle"></i> Onboard Device</a
                        >
                      </li>
                      <li>
                        <a href="sync_devices.html"
                          ><i class="fas fa-sync"></i> Sync Devices</a
                        >
                      </li>
                      <li>
                        <a href="scan-and-add.html"
                          ><i class="fas fa-search-plus"></i> Scan & Add</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Configs
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="backup.html"
                          ><i class="fas fa-save"></i> Backup</a
                        >
                      </li>
                      <li>
                        <a href="compare.html"
                          ><i class="fas fa-exchange-alt"></i> Compare</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Ansible
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="ansible-inventory.html"
                          ><i class="fas fa-list"></i> Inventory</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-wrench"></i> Settings
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="settings-nautobot.html"
                          ><i class="fas fa-server"></i> Nautobot</a
                        >
                      </li>
                      <li>
                        <a href="settings-templates.html"
                          ><i class="fas fa-file-code"></i> Templates</a
                        >
                      </li>
                      <li>
                        <a href="settings-git.html"
                          ><i class="fab fa-git-alt"></i> Git Management</a
                        >
                      </li>
                      <li>
                        <a href="settings-cache.html"
                          ><i class="fas fa-bolt"></i> Cache</a
                        >
                      </li>
                      <li>
                        <a href="settings-credentials.html" class="current-page"
                          ><i class="fas fa-key"></i> Credentials</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <div class="sidebar-footer hidden-small">
              <a
                href="settings-credentials.html"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Settings"
              >
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="FullScreen"
              >
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Logout"
                href="login.html"
              >
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
          </div>
        </div>
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav>
              <ul class="nav navbar-nav navbar-right">
                <li class=""><a id="navbar-username">User</a></li>
              </ul>
            </nav>
          </div>
        </div>
        <div class="right_col" role="main">
          <div class="page-title">
            <div class="title_left"><h3>Credentials</h3></div>
            <div class="title_right">
              <div id="statusMessage" class="pull-right small text-muted"></div>
            </div>
          </div>
          <div class="clearfix"></div>
          <div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>
                    Stored Credentials
                    <small>Passwords encrypted (never shown)</small>
                  </h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li>
                      <a id="btnNew" title="Add"><i class="fas fa-plus"></i></a>
                    </li>
                    <li>
                      <a id="btnReload" title="Reload"
                        ><i class="fas fa-sync"></i
                      ></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <table class="table table-striped" id="credentialsTable">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Type</th>
                        <th>Valid Until</th>
                        <th>Status</th>
                        <th style="width: 80px" class="actions-col">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="modal" id="credentialModal" tabindex="-1">
            <div class="modal-dialog modal-md">
              <div class="modal-content">
                <form id="credentialForm">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">New Credential</h5>
                  </div>
                  <div class="modal-body">
                    <input type="hidden" id="credId" />
                    <div class="mb-3">
                      <label class="form-label">Name</label
                      ><input
                        id="name"
                        class="form-control"
                        required
                        maxlength="128"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Username</label
                      ><input
                        id="username"
                        class="form-control"
                        required
                        maxlength="128"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Type</label
                      ><select id="type" class="form-control" required>
                        <option value="ssh">SSH</option>
                        <option value="tacacs">TACACS</option>
                        <option value="generic">Generic</option>
                        <option value="token">Token</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label id="passwordLabel" class="form-label"
                        >Password
                        <small id="passwordHint" class="text-muted"
                          >(required)</small
                        ></label
                      ><input
                        id="password"
                        class="form-control"
                        type="password"
                        autocomplete="new-password"
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Valid Until (optional)</label
                      ><input
                        id="valid_until"
                        class="form-control"
                        type="date"
                      />
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-light"
                      onclick="closeModal()"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-success" id="saveBtn">
                      Save
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[c],
        );
      }
      let currentId = null;
      function setStatus(m, c = "text-muted") {
        const el = document.getElementById("statusMessage");
        el.className = "small " + c;
        el.textContent = m;
      }
      function badge(st) {
        if (st === "expired")
          return '<span class="badge badge-expired">Expired</span>';
        if (st === "expiring")
          return '<span class="badge badge-expiring">Expiring</span>';
        return '<span class="badge badge-active">Active</span>';
      }
      async function loadCredentials() {
        try {
          setStatus("Loading...");
          const d = await window.authManager.apiRequest("/api/credentials/");
          renderTable(d);
          setStatus("");
        } catch (e) {
          console.error(e);
          setStatus("Load failed", "text-danger");
        }
      }
      function renderTable(items) {
        const tb = document.querySelector("#credentialsTable tbody");
        tb.innerHTML = items
          .map(
            (i) =>
              `<tr data-id="${i.id}"><td>${escapeHtml(i.name)}</td><td>${escapeHtml(i.username)}</td><td>${escapeHtml(i.type)}</td><td>${i.valid_until ? escapeHtml(i.valid_until) : ""}</td><td>${badge(i.status)}</td><td class="actions-cell"><div class="action-buttons"><button class='btn btn-primary btn-xs cred-btn edit-btn' title='Edit'><i class="fas fa-edit"></i></button><button class='btn btn-danger btn-xs cred-btn del-btn' title='Delete'><i class="fas fa-trash"></i></button></div></td></tr>`,
          )
          .join("");
      }
      function updatePasswordLabel() {
        const type = document.getElementById("type").value;
        const lbl = document.getElementById("passwordLabel");
        const hintEl = document.getElementById("passwordHint");
        const hintText = hintEl ? hintEl.textContent : "(required)";
        if (type === "token") {
          lbl.innerHTML = `Token <small id="passwordHint" class="text-muted">${hintText}</small>`;
        } else {
          lbl.innerHTML = `Password <small id="passwordHint" class="text-muted">${hintText}</small>`;
        }
      }
      function openNew() {
        currentId = null;
        document.getElementById("credId").value = "";
        document.getElementById("name").value = "";
        document.getElementById("username").value = "";
        document.getElementById("type").value = "ssh";
        document.getElementById("password").value = "";
        document.getElementById("valid_until").value = "";
        document.getElementById("passwordHint").textContent = "(required)";
        updatePasswordLabel();
        document.getElementById("modalTitle").textContent = "New Credential";
        document.getElementById("credentialModal").style.display = "block";
      }
      function openEdit(row) {
        currentId = row.getAttribute("data-id");
        document.getElementById("credId").value = currentId;
        document.getElementById("name").value = row.children[0].textContent;
        document.getElementById("username").value = row.children[1].textContent;
        document.getElementById("type").value = row.children[2].textContent;
        document.getElementById("valid_until").value =
          row.children[3].textContent || "";
        document.getElementById("password").value = "";
        document.getElementById("passwordHint").textContent =
          "(leave blank to keep)";
        updatePasswordLabel();
        document.getElementById("modalTitle").textContent = "Edit Credential";
        document.getElementById("credentialModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("credentialModal").style.display = "none";
      }
      async function save(e) {
        e.preventDefault();
        const id = document.getElementById("credId").value.trim();
        const type = document.getElementById("type").value;
        const payload = {
          name: document.getElementById("name").value.trim(),
          username: document.getElementById("username").value.trim(),
          type,
          valid_until: document.getElementById("valid_until").value || null,
        };
        const pw = document.getElementById("password").value;
        if (!id && !pw) {
          alert(type === "token" ? "Token required" : "Password required");
          return;
        }
        if (pw) payload.password = pw;
        try {
          setStatus("Saving...");
          if (id) {
            await window.authManager.apiRequest(`/api/credentials/${id}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
          } else {
            await window.authManager.apiRequest("/api/credentials/", {
              method: "POST",
              body: JSON.stringify(payload),
            });
          }
          closeModal();
          setStatus("Saved", "text-success");
          loadCredentials();
        } catch (err) {
          console.error(err);
          setStatus("Save failed", "text-danger");
        }
      }
      async function del(id) {
        if (!confirm("Delete credential?")) return;
        try {
          await window.authManager.apiRequest(`/api/credentials/${id}`, {
            method: "DELETE",
          });
          setStatus("Deleted", "text-warning");
          loadCredentials();
        } catch (e) {
          console.error(e);
          setStatus("Delete failed", "text-danger");
        }
      }
      document.addEventListener("DOMContentLoaded", async () => {
        await window.authManager?.waitUntilReady?.();
        document.getElementById("btnNew").addEventListener("click", openNew);
        document
          .getElementById("btnReload")
          .addEventListener("click", loadCredentials);
        document
          .getElementById("credentialForm")
          .addEventListener("submit", save);
        document
          .querySelector("#credentialsTable tbody")
          .addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            if (!row) return;
            if (e.target.classList.contains("edit-btn")) openEdit(row);
            else if (e.target.classList.contains("del-btn"))
              del(row.getAttribute("data-id"));
          });
        document
          .getElementById("type")
          .addEventListener("change", updatePasswordLabel);
        loadCredentials();
      });
    </script>
  </body>
</html>
