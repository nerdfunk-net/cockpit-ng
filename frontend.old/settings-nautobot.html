<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="images/favicon.ico" type="image/ico" />

    <title>Nautobot Settings - Cockpit</title>

    <!-- Vite Entry Point - will bundle all styles -->
    <script type="module" src="/src/main-minimal.js"></script>

    <!-- Configuration -->
    <script src="js/config.js"></script>
    <!-- Container configuration (if in container mode) -->
    <script>
      // Load container config if in container environment
      // But NOT if we're running on Vite dev server ports (development mode)
      const currentPort = window.location.port;
      const isDevelopment = currentPort === "3000" || currentPort === "3001";
      const isNonLocalhost =
        window.location.hostname !== "localhost" &&
        window.location.hostname !== "127.0.0.1";

      if (isNonLocalhost && !isDevelopment) {
        const script = document.createElement("script");
        script.src = "js/config-container.js";
        document.head.appendChild(script);
      }
    </script>
    <!-- API Manager -->
    <script src="js/api-manager.js"></script>
    <script>
      // Robust authentication check
      (function () {
        console.log("Checking authentication...");

        // Check if we have a valid token
        const token = localStorage.getItem("auth_token");
        console.log("Token found:", !!token);

        if (!token) {
          console.log("No token found, redirecting to login");
          // Use absolute path to ensure proper redirect
          window.location.href = "/login.html";
          return;
        }

        console.log("Token found, user authenticated");
      })();
    </script>
    <script src="js/auth.js"></script>
    <script>
      // Initialize auth manager when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        window.authManager = new AuthManager();
        console.log("AuthManager initialized");
      });
    </script>
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0">
              <a href="index.html" class="site_title"
                ><i class="fas fa-paw"></i> <span>Cockpit!</span></a
              >
            </div>

            <div class="clearfix"></div>

            <!-- menu profile quick info -->
            <div class="profile clearfix">
              <div class="profile_pic"></div>
              <div class="profile_info">
                <span id="welcome-message">Welcome,</span>
                <h2 id="sidebar-username">Loading...</h2>
              </div>
            </div>
            <!-- /menu profile quick info -->

            <br />

            <!-- sidebar menu -->
            <div
              id="sidebar-menu"
              class="main_menu_side hidden-print main_menu"
            >
              <div class="menu_section">
                <h3>General</h3>
                <ul class="nav side-menu">
                  <li>
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-rocket"></i> Onboarding
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="onboard-device.html"
                          ><i class="fas fa-plus-circle"></i> Onboard Device</a
                        >
                      </li>
                      <li>
                        <a href="sync_devices.html"
                          ><i class="fas fa-sync"></i> Sync Devices</a
                        >
                      </li>
                      <li>
                        <a href="scan-and-add.html"
                          ><i class="fas fa-search-plus"></i> Scan & Add</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Configs
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="backup.html"
                          ><i class="fas fa-save"></i> Backup</a
                        >
                      </li>
                      <li>
                        <a href="compare.html"
                          ><i class="fas fa-exchange-alt"></i> Compare</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-cogs"></i> Ansible
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="ansible-inventory.html"
                          ><i class="fas fa-list"></i> Inventory</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a
                      ><i class="fas fa-wrench"></i> Settings
                      <span class="fas fa-chevron-down"></span
                    ></a>
                    <ul class="nav child_menu">
                      <li>
                        <a href="settings-nautobot.html" class="current-page"
                          ><i class="fas fa-server"></i> Nautobot</a
                        >
                      </li>
                      <li>
                        <a href="settings-templates.html"
                          ><i class="fas fa-file-code"></i> Templates</a
                        >
                      </li>
                      <li>
                        <a href="settings-git.html"
                          ><i class="fab fa-git-alt"></i> Git Management</a
                        >
                      </li>
                      <li>
                        <a href="settings-cache.html"
                          ><i class="fas fa-bolt"></i> Cache</a
                        >
                      </li>
                      <li>
                        <a href="settings-credentials.html"
                          ><i class="fas fa-key"></i> Credentials</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->

            <!-- /menu footer buttons -->
            <div class="sidebar-footer hidden-small">
              <a
                href="settings-nautobot.html"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Settings"
              >
                <span class="fas fa-cog" aria-hidden="true"></span>
              </a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="FullScreen"
              >
                <span class="fas fa-expand" aria-hidden="true"></span>
              </a>
              <a data-bs-toggle="tooltip" data-bs-placement="top" title="Lock">
                <span class="fas fa-eye-slash" aria-hidden="true"></span>
              </a>
              <a
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Logout"
                href="login.html"
              >
                <span class="fas fa-power-off" aria-hidden="true"></span>
              </a>
            </div>
            <!-- /menu footer buttons -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fas fa-bars"></i></a>
            </div>
            <nav class="nav navbar-nav">
              <ul class="navbar-right">
                <li class="nav-item dropdown open" style="padding-left: 15px">
                  <a
                    href="javascript:;"
                    class="user-profile dropdown-toggle"
                    aria-haspopup="true"
                    id="navbarDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <span id="navbar-username">Loading...</span>
                  </a>
                  <script>
                    // Immediate username update if user info is available
                    (function () {
                      const userInfo = localStorage.getItem("user_info");
                      if (userInfo) {
                        try {
                          const user = JSON.parse(userInfo);
                          const element =
                            document.getElementById("navbar-username");
                          if (element && user) {
                            element.textContent =
                              user.full_name || user.username || "User";
                          }
                        } catch (e) {
                          console.log("Error parsing user info:", e);
                        }
                      }
                    })();
                  </script>
                  <div
                    class="dropdown-menu dropdown-usermenu pull-right"
                    aria-labelledby="navbarDropdown"
                  >
                    <a
                      class="dropdown-item"
                      href="javascript:;"
                      onclick="logout()"
                      ><i class="fas fa-power-off pull-right"></i> Log Out</a
                    >
                  </div>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>Nautobot Settings</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <!-- Settings Content -->
            <div class="row">
              <div class="col-md-12 col-sm-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>
                      Nautobot Configuration
                      <small>Configure your Nautobot server connection</small>
                    </h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li>
                        <a class="collapse-link"
                          ><i class="fas fa-chevron-up"></i
                        ></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>

                  <!-- Status Message Area -->
                  <div id="status-message" style="display: none"></div>

                  <div class="x_content">
                    <!-- Nautobot Settings Section -->
                    <div class="row">
                      <div class="col-md-12">
                        <h3 class="section-heading">
                          <i class="fas fa-server"></i> Nautobot Connection
                          Settings
                        </h3>
                        <hr class="section-divider" />
                      </div>
                    </div>

                    <form id="nautobot-settings-form">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="nautobot-url" class="control-label"
                              >Nautobot Server URL
                              <span class="required">*</span></label
                            >
                            <input
                              type="url"
                              id="nautobot-url"
                              class="form-control"
                              placeholder="https://nautobot.example.com"
                              required
                            />
                            <small class="form-text text-muted"
                              >The base URL of your Nautobot instance</small
                            >
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="nautobot-token" class="control-label"
                              >API Token <span class="required">*</span></label
                            >
                            <input
                              type="password"
                              id="nautobot-token"
                              class="form-control"
                              placeholder="Enter your Nautobot API token (e.g., aaabbbccc123456789)"
                              required
                            />
                            <small class="form-text text-muted"
                              >Get your API token from Nautobot: Admin → Users →
                              [Your User] → API Tokens.
                              <strong>Required permissions:</strong> At minimum
                              'read' access to dcim models (devices, sites,
                              etc.)</small
                            >
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="nautobot-timeout" class="control-label"
                              >Connection Timeout (seconds)</label
                            >
                            <input
                              type="number"
                              id="nautobot-timeout"
                              class="form-control"
                              value="30"
                              min="5"
                              max="300"
                            />
                            <small class="form-text text-muted"
                              >Request timeout in seconds (default: 30)</small
                            >
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label
                              for="nautobot-verify-ssl"
                              class="control-label"
                              >SSL Verification</label
                            >
                            <input
                              type="checkbox"
                              id="nautobot-verify-ssl"
                              class="form-check-input"
                            />
                            <label
                              for="nautobot-verify-ssl"
                              class="form-check-label"
                              >Verify SSL certificates</label
                            >
                            <small class="form-text text-muted"
                              >Uncheck only for development environments</small
                            >
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-12">
                          <button
                            type="button"
                            id="test-nautobot-connection"
                            class="btn btn-info btn-sm"
                          >
                            <i class="fas fa-plug"></i> Test Connection
                          </button>
                          <span
                            id="nautobot-connection-status"
                            class="ml-3"
                          ></span>
                        </div>
                      </div>
                    </form>

                    <!-- Save Button -->
                    <div class="row" style="margin-top: 40px">
                      <div class="col-md-12">
                        <hr />
                        <button
                          type="button"
                          id="save-settings"
                          class="btn btn-success"
                        >
                          <i class="fas fa-save"></i> Save Nautobot Settings
                        </button>
                        <button
                          type="button"
                          id="reset-settings"
                          class="btn btn-warning ml-3"
                        >
                          <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /Settings Content -->
          </div>
        </div>
        <!-- /page content -->
      </div>
    </div>

    <!-- Custom styles for current page indication -->
    <style>
      .current-page {
        background-color: #2a3f54 !important;
        color: #fff !important;
        border-radius: 3px;
      }

      .current-page:hover {
        background-color: #1e2b3a !important;
      }

      /* Top status message styling */
      #status-message {
        margin-top: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-weight: 500;
      }

      .section-heading {
        color: #2a3f54;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-divider {
        border-top: 2px solid #e6e9ed;
        margin-bottom: 25px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .required {
        color: red;
      }
    </style>

    <!-- JavaScript for Settings Functionality -->
    <script>
      class NautobotSettings {
        constructor() {
          this.init();
        }

        init() {
          // Wait for auth manager to be ready
          document.addEventListener("DOMContentLoaded", () => {
            this.setupEventListeners();
            this.loadSettings();
            this.updateUsernameDisplay();
          });
        }

        setupEventListeners() {
          document
            .getElementById("test-nautobot-connection")
            .addEventListener("click", () => this.testNautobotConnection());
          document
            .getElementById("save-settings")
            .addEventListener("click", () => this.saveSettings());
          document
            .getElementById("reset-settings")
            .addEventListener("click", () => this.resetSettings());
        }

        async loadSettings() {
          if (!window.authManager) {
            setTimeout(() => this.loadSettings(), 500);
            return;
          }

          try {
            const response = await window.authManager.apiRequest(
              "/api/settings/nautobot",
            );
            if (response.success) {
              this.populateForm(response.data);
            }
          } catch (error) {
            console.error("Error loading Nautobot settings:", error);
          }
        }

        populateForm(settings) {
          // Nautobot settings
          document.getElementById("nautobot-url").value = settings.url || "";
          document.getElementById("nautobot-token").value =
            settings.token || "";
          document.getElementById("nautobot-timeout").value =
            settings.timeout || 30;
          document.getElementById("nautobot-verify-ssl").checked =
            settings.verify_ssl !== false;
        }

        async testNautobotConnection() {
          const statusElement = document.getElementById(
            "nautobot-connection-status",
          );
          statusElement.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Testing...';

          const settings = {
            url: document.getElementById("nautobot-url").value,
            token: document.getElementById("nautobot-token").value,
            timeout: parseInt(
              document.getElementById("nautobot-timeout").value,
            ),
            verify_ssl: document.getElementById("nautobot-verify-ssl").checked,
          };

          try {
            const response = await window.authManager.apiRequest(
              "/api/settings/test/nautobot",
              {
                method: "POST",
                body: JSON.stringify(settings),
              },
            );

            if (response.success) {
              statusElement.innerHTML =
                '<span class="text-success"><i class="fas fa-check"></i> Connection successful!</span>';
            } else {
              statusElement.innerHTML = `<span class="text-danger"><i class="fas fa-times"></i> ${response.message}</span>`;
            }
          } catch (error) {
            statusElement.innerHTML =
              '<span class="text-danger"><i class="fas fa-times"></i> Connection failed</span>';
          }
        }

        async saveSettings() {
          const settings = {
            url: document.getElementById("nautobot-url").value,
            token: document.getElementById("nautobot-token").value,
            timeout: parseInt(
              document.getElementById("nautobot-timeout").value,
            ),
            verify_ssl: document.getElementById("nautobot-verify-ssl").checked,
          };

          try {
            const response = await window.authManager.apiRequest(
              "/api/settings/nautobot",
              {
                method: "POST",
                body: JSON.stringify(settings),
              },
            );

            if (response.success) {
              this.showStatus(
                "Nautobot settings saved successfully!",
                "success",
              );
            } else {
              this.showStatus(
                "Failed to save settings: " + response.message,
                "error",
              );
            }
          } catch (error) {
            this.showStatus("Error saving settings: " + error.message, "error");
          }
        }

        resetSettings() {
          document.getElementById("nautobot-url").value = "";
          document.getElementById("nautobot-token").value = "";
          document.getElementById("nautobot-timeout").value = "30";
          document.getElementById("nautobot-verify-ssl").checked = true;
          this.showStatus("Settings reset to defaults", "info");
        }

        showStatus(message, type) {
          const statusDiv = document.getElementById("status-message");
          const alertClass =
            type === "success"
              ? "alert-success"
              : type === "error"
                ? "alert-danger"
                : "alert-info";

          statusDiv.className = `alert ${alertClass}`;
          statusDiv.innerHTML = message;
          statusDiv.style.display = "block";

          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 5000);
        }

        updateUsernameDisplay() {
          // Update username in sidebar and navbar
          const userInfo = localStorage.getItem("user_info");
          if (userInfo) {
            try {
              const user = JSON.parse(userInfo);
              const sidebarElement =
                document.getElementById("sidebar-username");
              const navbarElement = document.getElementById("navbar-username");

              const displayName = user.full_name || user.username || "User";

              if (sidebarElement) sidebarElement.textContent = displayName;
              if (navbarElement) navbarElement.textContent = displayName;
            } catch (e) {
              console.log("Error parsing user info:", e);
            }
          }
        }
      }

      // Initialize settings when page loads
      const nautobotSettings = new NautobotSettings();

      function logout() {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("user_info");
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>
