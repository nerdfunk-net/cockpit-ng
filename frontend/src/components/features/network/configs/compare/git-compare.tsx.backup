'use client'

import React, { useState, useEffect, useCallback, useMemo } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import {
  GitCommit,
  GitCompare as GitCompareIcon,
  ChevronUp,
  ChevronDown,
  RefreshCw
} from 'lucide-react'
import { useApi } from '@/hooks/use-api'
import {
  useGitRepositories,
  useGitBranches,
  useGitCommits,
  useFileSearch,
  useDiffNavigation
} from '@/hooks/git'
import {
  RepositorySelector,
  BranchSelector,
  CommitSelector,
  FileSearchInput,
  DiffControls
} from './shared'
import {
  getLeftLineClass,
  getRightLineClass,
  exportDiffAsText
} from '@/lib/compare-utils'
import type {
  FileItem,
  ComparisonResult,
  GitRepository
} from '@/types/git'

export default function GitCompare() {
  const { apiCall } = useApi()

  // Commit selection state (must be before hooks that use callbacks)
  const [leftCommit, setLeftCommit] = useState<string>('')
  const [rightCommit, setRightCommit] = useState<string>('')
  const [comparisonResult, setComparisonResult] = useState<ComparisonResult | null>(null)
  const [showComparison, setShowComparison] = useState(false)

  // Use custom hooks for state management
  const { repositories, selectedRepo, setSelectedRepo } = useGitRepositories()

  // IMPORTANT: Stable callback to prevent infinite loops
  const handleBranchChange = useCallback(() => {
    setLeftCommit('')
    setRightCommit('')
    setComparisonResult(null)
    setShowComparison(false)
  }, [])

  // IMPORTANT: Memoize options object to ensure stable reference
  const branchOptions = useMemo(() => ({ 
    onBranchChange: handleBranchChange 
  }), [handleBranchChange])

  const { branches, selectedBranch, setSelectedBranch } = useGitBranches(
    selectedRepo?.id || null,
    branchOptions
  )

  // Memoized callback for repository changes
  // NOTE: setSelectedRepo is a setState function and is stable, so we can safely omit it
  const handleRepoChange = useCallback((repo: GitRepository | null) => {
    setSelectedRepo(repo)
    setLeftCommit('')
    setRightCommit('')
    setComparisonResult(null)
    setShowComparison(false)
  }, [])
  const { commits } = useGitCommits(selectedRepo?.id || null, selectedBranch)
  const diffNav = useDiffNavigation()

  // File loading and search state
  const [gitFiles, setGitFiles] = useState<FileItem[]>([])
  const fileSearch = useFileSearch(gitFiles)
  const [loading, setLoading] = useState(false)

  // Load files when repository changes
  const loadFiles = useCallback(async () => {
    if (!selectedRepo) {
      setGitFiles([])
      return
    }

    try {
      const response = await apiCall<{files: FileItem[]}>(`file-compare/list?repo_id=${selectedRepo.id}`)
      const files = Array.isArray(response?.files) ? response.files : []
      setGitFiles(files)
    } catch (error) {
      console.error('Error loading files:', error)
      setGitFiles([])
    }
  }, [selectedRepo, apiCall])

  useEffect(() => {
    loadFiles()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedRepo])

  const canCompare = () => {
    return selectedRepo && leftCommit && leftCommit.trim() !== '' &&
           rightCommit && rightCommit.trim() !== '' &&
           fileSearch.selectedFile && leftCommit !== rightCommit
  }

  const handleCompare = async () => {
    if (!canCompare() || !selectedRepo) return

    setLoading(true)
    try {
      const response = await apiCall<ComparisonResult>(`git/${selectedRepo.id}/diff`, {
        method: 'POST',
        body: JSON.stringify({
          commit1: leftCommit,
          commit2: rightCommit,
          file_path: fileSearch.selectedFile!.path
        })
      })

      setComparisonResult(response)
      setShowComparison(true)
      diffNav.setCurrentIndex(0)
    } catch (error) {
      console.error('Error comparing commits:', error)
    } finally {
      setLoading(false)
    }
  }

  const exportDiff = () => {
    if (!comparisonResult) return
    exportDiffAsText(comparisonResult, `git-diff-${Date.now()}.patch`)
  }

  const navigateDiff = (direction: 'next' | 'prev') => {
    if (!comparisonResult) return
    
    if (direction === 'next') {
      diffNav.nextDiff()
    } else {
      diffNav.prevDiff()
    }
  }


  return (
    <div key="unique-id-gc-1" className="space-y-6">
      {/* Header */}
      <div key="unique-id-gc-2" className="flex items-center justify-between">
        <div key="unique-id-gc-3">
          <h2 key="unique-id-gc-4" className="text-2xl font-bold text-gray-900">Git Commit Comparison</h2>
          <p key="unique-id-gc-5" className="text-gray-600 mt-1">Compare files between different Git commits</p>
        </div>
      </div>

      {/* Git Selection */}
      <div key="unique-id-gc-7" className="shadow-lg border-0 p-0 bg-white rounded-lg">
        <div key="unique-id-gc-8" className="bg-gradient-to-r from-blue-400/80 to-blue-500/80 text-white py-2 px-4 flex items-center justify-between rounded-t-lg">
          <div className="flex items-center space-x-2">
            <GitCommit className="h-4 w-4" />
            <span className="text-sm font-medium">Select Commits and File</span>
          </div>
          <div className="text-xs text-blue-100">
            Choose branch, commits, and file to compare between Git revisions
          </div>
        </div>
        <div key="unique-id-gc-10" className="p-6 bg-gradient-to-b from-white to-gray-50">
          <div key="unique-id-gc-11" className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <RepositorySelector
              repositories={repositories}
              selectedRepo={selectedRepo}
              onSelectRepo={handleRepoChange}
            />

            <BranchSelector
              branches={branches}
              selectedBranch={selectedBranch}
              onSelectBranch={setSelectedBranch}
              disabled={!selectedRepo}
            />

            <CommitSelector
              commits={commits}
              selectedCommit={leftCommit}
              onSelectCommit={setLeftCommit}
              label="Source Commit"
              placeholder="Select source commit"
              disabled={!selectedBranch}
            />

            <CommitSelector
              commits={commits}
              selectedCommit={rightCommit}
              onSelectCommit={setRightCommit}
              label="Target Commit"
              placeholder="Select target commit"
              disabled={!selectedBranch}
            />
          </div>

          <FileSearchInput
            label="File to Compare"
            placeholder="Search for file..."
            searchQuery={fileSearch.searchQuery}
            onSearchQueryChange={fileSearch.setSearchQuery}
            showResults={fileSearch.showResults}
            onShowResultsChange={fileSearch.setShowResults}
            filteredFiles={fileSearch.filteredFiles}
            onFileSelect={fileSearch.setSelectedFile}
            searchRef={fileSearch.searchRef}
            disabled={!selectedRepo}
          />
        </div>
      </div>

      {/* Compare Actions */}
      <div key="unique-id-gc-43" className="shadow-lg border-0 p-0 bg-white rounded-lg">
        <div className="bg-gradient-to-r from-blue-400/80 to-blue-500/80 text-white py-2 px-4 flex items-center justify-between rounded-t-lg">
          <div className="flex items-center space-x-2">
            <GitCompareIcon className="h-4 w-4" />
            <span className="text-sm font-medium">Git Compare Actions</span>
          </div>
          <div className="text-xs text-blue-100">
            Execute Git comparison and configure display options
          </div>
        </div>
        <div key="unique-id-gc-44" className="p-6 bg-gradient-to-b from-white to-gray-50">
          <div key="unique-id-gc-45" className="flex items-center justify-between">
            <div key="unique-id-gc-46" className="flex items-center gap-2">
            <Button 
              key="unique-id-gc-47"
              onClick={handleCompare} 
              disabled={!canCompare() || loading}
              className="flex items-center gap-2"
            >
              {loading ? (
                <RefreshCw key="unique-id-gc-48" className="h-4 w-4 animate-spin" />
              ) : (
                <GitCompareIcon key="unique-id-gc-49" className="h-4 w-4" />
              )}
              <span key="unique-id-gc-50">Compare Commits</span>
            </Button>
            </div>

            {comparisonResult && (
              <DiffControls
                fontSize={diffNav.fontSize}
                onFontSizeChange={diffNav.setFontSize}
                hideUnchanged={diffNav.hideUnchanged}
                onHideUnchangedToggle={diffNav.toggleHideUnchanged}
                onExport={exportDiff}
              />
            )}
          </div>
        </div>
      </div>

      {/* Comparison Results */}
      {showComparison && comparisonResult && (
        <Card key="unique-id-gc-60" className="shadow-lg border-0 p-0">
          <CardHeader key="unique-id-gc-61" className="bg-gradient-to-r from-blue-400/80 to-blue-500/80 text-white border-b-0 rounded-none m-0 p-4">
            <div key="unique-id-gc-62" className="flex items-center justify-between">
              <div key="unique-id-gc-63">
                <CardTitle key="unique-id-gc-64" className="flex items-center gap-2 text-white text-base">
                  <GitCompareIcon key="unique-id-gc-65" className="h-4 w-4" />
                  <span key="unique-id-gc-66">Git Commit Comparison Results</span>
                </CardTitle>
                <div key="unique-id-gc-67" className="text-blue-50 mt-1 text-sm">
                  {comparisonResult.left_file} â†” {comparisonResult.right_file}
                </div>
              </div>
              <div key="unique-id-gc-68" className="flex items-center gap-2">
                <div key="unique-id-gc-69" className="text-sm text-blue-50">
                  <span key="unique-id-gc-70" className="text-green-200">+{comparisonResult.stats.additions}</span>
                  <span key="unique-id-gc-71"> </span>
                  <span key="unique-id-gc-72" className="text-red-200">-{comparisonResult.stats.deletions}</span>
                  <span key="unique-id-gc-73"> </span>
                  <span key="unique-id-gc-74" className="text-blue-200">{comparisonResult.stats.changes} changes</span>
                </div>
                <div key="unique-id-gc-75" className="flex items-center gap-1">
                  <Button
                    key="unique-id-gc-76"
                    size="sm"
                    variant="outline"
                    onClick={() => navigateDiff('prev')}
                    disabled={diffNav.currentIndex === 0}
                    className="bg-white/20 border-white/30 text-white hover:bg-white/30"
                  >
                    <ChevronUp key="unique-id-gc-77" className="h-4 w-4" />
                  </Button>
                  <Button
                    key="unique-id-gc-78"
                    size="sm"
                    variant="outline"
                    onClick={() => navigateDiff('next')}
                    disabled={(() => {
                      const visibleDiffs = comparisonResult.left_lines.filter(d => d.type !== 'equal')
                      return diffNav.currentIndex >= visibleDiffs.length - 1
                    })()}
                    className="bg-white/20 border-white/30 text-white hover:bg-white/30"
                  >
                    <ChevronDown key="unique-id-gc-79" className="h-4 w-4" />
                  </Button>
                </div>
                <Button
                  key="unique-id-gc-80"
                  size="sm"
                  variant="outline"
                  onClick={() => setShowComparison(false)}
                  className="bg-white/20 border-white/30 text-white hover:bg-white/30"
                >
                  <span key="unique-id-gc-81">Close</span>
                </Button>
              </div>
            </div>
          </CardHeader>
          <CardContent key="unique-id-gc-82" className="p-6 bg-gradient-to-b from-white to-gray-50">
            <div 
              key="unique-id-gc-83"
              className="border rounded-lg overflow-auto font-mono"
              style={{ fontSize: `${diffNav.fontSize}px`, maxHeight: '600px' }}
            >
              {/* Side-by-side comparison header */}
              <div key="unique-id-gc-header" className="grid grid-cols-2 bg-gray-100 border-b sticky top-0" style={{ fontSize: `${Math.max(diffNav.fontSize - 2, 8)}px` }}>
                <div key="unique-id-gc-left-header" className="p-2 border-r font-semibold text-gray-700">
                  {comparisonResult.commit1}: {comparisonResult.left_file}
                </div>
                <div key="unique-id-gc-right-header" className="p-2 font-semibold text-gray-700">
                  {comparisonResult.commit2}: {comparisonResult.right_file}
                </div>
              </div>

              {/* Side-by-side comparison content */}
              {(() => {
                // Create synchronized rows for side-by-side comparison
                const maxLines = Math.max(comparisonResult.left_lines.length, comparisonResult.right_lines.length)
                const rows = []
                
                for (let i = 0; i < maxLines; i++) {
                  const leftLine = comparisonResult.left_lines[i]
                  const rightLine = comparisonResult.right_lines[i]
                  
                  // Skip if both lines are equal and diffNav.hideUnchanged is true
                  if (diffNav.hideUnchanged && leftLine?.type === 'equal' && rightLine?.type === 'equal') {
                    continue
                  }
                  
                  rows.push(
                    <div key={`unique-id-gc-row-${i}`} className="grid grid-cols-2 border-b border-gray-200 hover:bg-gray-50">
                      {/* Left side (commit1) */}
                      <div key={`unique-id-gc-left-${i}`} className={`flex items-start border-r ${getLeftLineClass(leftLine?.type || 'empty')}`}>
                        <div key={`unique-id-gc-left-num-${i}`} className="flex-shrink-0 w-12 text-gray-500 text-right text-xs p-1 bg-gray-50 border-r">
                          {leftLine?.line_number || ''}
                        </div>
                        <div key={`unique-id-gc-left-content-${i}`} className="flex-1 p-2 whitespace-pre-wrap break-all min-h-[1.4em]">
                          {leftLine?.content || ' '}
                        </div>
                      </div>

                      {/* Right side (commit2) */}
                      <div key={`unique-id-gc-right-${i}`} className={`flex items-start ${getRightLineClass(rightLine?.type || 'empty')}`}>
                        <div key={`unique-id-gc-right-num-${i}`} className="flex-shrink-0 w-12 text-gray-500 text-right text-xs p-1 bg-gray-50 border-r">
                          {rightLine?.line_number || ''}
                        </div>
                        <div key={`unique-id-gc-right-content-${i}`} className="flex-1 p-2 whitespace-pre-wrap break-all min-h-[1.4em]">
                          {rightLine?.content || ' '}
                        </div>
                      </div>
                    </div>
                  )
                }
                
                return rows
              })()}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  )
}
